<!-- src/routes/+layout.svelte -->
<script>
  import '../app.css';
  import { onMount } from 'svelte';
  import { page } from '$app/stores';
  import { locale, setLocale } from '$lib/i18n';
  import Navigation from '$lib/components/Navigation.svelte';
  import NLWebSearch from '$lib/components/NLWebSearch.svelte';
  import AIArtAssistant from '$lib/components/AIArtAssistant.svelte';
  import { browser } from '$app/environment';
  
  // Capture data from server with safe defaults
  let { data = {} } = $props();
  
  // FIXED: Use $derived instead of $: for reactivity in Runes mode
  let isAdmin = $derived(data?.isAdmin ?? false);
  
  // Check if current page needs full-height layout (no top margin)
  // FIXED: Also changed $: to $derived
  let isFullHeightPage = $derived($page.url.pathname === '/about');
  
  // Initialize locale on client
  onMount(() => {
    //1. Check localStorage for preferred language
    let lang = localStorage.getItem('preferredLanguage');
    
    //2. Default to Spanish if none set
    if (!lang || !['es', 'en', 'fr'].includes(lang)) {
      lang = 'es';
      localStorage.setItem('preferredLanguage', lang);
    }
    
    //3. Set the locale (instant, no loading needed!)
    setLocale(lang);
    
    //4. Suppress Cloudflare Stream beacon errors (browser only)
    if (browser) {
      const originalError = console.error;
      console.error = function(...args) {
        if (args[0] && typeof args[0] === 'string' &&
            args[0].includes('cloudflarestream.com/cdn-cgi/beacon/media')) {
          return;
        }
        originalError.apply(console, args);
      };
      
      window.addEventListener('error', (event) => {
        if (event.target && event.target.src && 
            event.target.src.includes('cloudflarestream.com/cdn-cgi/beacon/media')) {
          event.preventDefault();
          event.stopPropagation();
          return false;
        }
      }, true);
    }
    
    //5. Save locale changes to localStorage
    const unsubscribeLocale = locale.subscribe((newLang) => {
      if (newLang && ['es', 'en', 'fr'].includes(newLang)) {
        localStorage.setItem('preferredLanguage', newLang);
      }
    });
    
    // Cleanup on unmount
    return () => {
      unsubscribeLocale();
    };
  });
</script>

<!-- Keep your existing HTML and Styles ... -->
<div class="app">
  <Navigation {isAdmin} />  

  <main class:full-height={isFullHeightPage}>
    <slot />
  </main>
  
  <footer>
    <p>&copy; 2025 Antoine Patraldo. All rights reserved.</p>
  </footer>

<NLWebSearch />
<AIArtAssistant />
</div>

