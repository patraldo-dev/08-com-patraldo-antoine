<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Opening Title</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            overflow: hidden;
            background: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #canvas-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
        }
        #title-overlay, .film-strip, .loading, .progress-bar {
            /* Ensure they’re visible during capture */
            z-index: 2; position: fixed; color: white;
        }
        .film-strip {
            position: fixed;
            width: 100%; height: 10px;
            background: repeating-linear-gradient(to right, transparent 20px, rgba(255,255,255,0.1) 20px 40px);
        }
        .film-strip.top { top: 0; }
        .film-strip.bottom { bottom: 0; }
        .cinema-name {
            font-size: 6rem; font-weight: 300; letter-spacing: 8px;
            text-transform: uppercase;
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255,126,95,0.3);
        }
        .tagline {
            font-size: 1.5rem; max-width: 600px; line-height: 1.6; color: #ddd;
        }
        #record-button {
            position: fixed; bottom: 20px; left: 20px; z-index: 100;
            padding: 12px 20px; font-size: 1.2rem; background: red; color: white;
            border: none; border-radius: 4px; cursor: pointer;
        }
        #record-button.recording { background: gray; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="film-strip top"></div>
    <div class="film-strip bottom"></div>
    <div id="canvas-container"></div>
    <div class="loading">CINEMA PRESENTS</div>
    <div id="title-overlay">
        <h1 class="cinema-name">CINEMA NOVA</h1>
        <p class="tagline">Where stories come to life on the silver screen</p>
    </div>
    <div class="progress-bar" id="progress"></div>

    <!-- One-time user gesture required -->
    <button id="record-button">Record Full Animation</button>

    <script>
        let scene, camera, renderer, clock;
        let filmReels = [];
        let physicsWorld;
        let container;
        let progress = 0;
        let isAnimating = false;

        // ========== Three.js & Matter.js init (unchanged) ==========
        function initThreeJS() {
            container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000); // Match body
            scene.fog = new THREE.Fog(0x0a0a0a, 15, 30);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 20;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambient);
            const dir = new THREE.DirectionalLight(0xffffff, 0.8);
            dir.position.set(5, 10, 7);
            scene.add(dir);
            window.addEventListener('resize', onWindowResize);
        }

        function initMatterJS() {
            const { Engine, World, Bodies } = Matter;
            physicsWorld = Engine.create();
            physicsWorld.gravity.y = 0;
            const bounds = [
                Bodies.rectangle(window.innerWidth/2, -50, window.innerWidth, 100, { isStatic: true }),
                Bodies.rectangle(window.innerWidth/2, window.innerHeight+50, window.innerWidth, 100, { isStatic: true }),
                Bodies.rectangle(-50, window.innerHeight/2, 100, window.innerHeight, { isStatic: true }),
                Bodies.rectangle(window.innerWidth+50, window.innerHeight/2, 100, window.innerHeight, { isStatic: true })
            ];
            World.add(physicsWorld.world, bounds);
            for (let i = 0; i < 12; i++) {
                const size = 1.5 + Math.random() * 1.5;
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight;
                const geom = new THREE.CylinderGeometry(0.8*size, 0.8*size, 0.3*size, 32);
                const mat = new THREE.MeshPhongMaterial({ color: 0xff7e5f, shininess: 80, transparent: true, opacity: 0.9 });
                const reel = new THREE.Mesh(geom, mat);
                reel.position.set((x - window.innerWidth/2)*0.02, (y - window.innerHeight/2)*0.02, (Math.random()-0.5)*5);
                reel.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, 0);
                scene.add(reel);
                const body = Bodies.circle(x, y, 30*size, { restitution:0.9, friction:0.01, frictionAir:0.02, render:{visible:false} });
                body.three = reel;
                World.add(physicsWorld.world, body);
                filmReels.push(body);
                Matter.Body.setVelocity(body, { x:(Math.random()-0.5)*5, y:(Math.random()-0.5)*5 });
                Matter.Body.setAngularVelocity(body, (Math.random()-0.5)*0.05);
            }
            Engine.run(physicsWorld);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            if (!isAnimating) return;
            requestAnimationFrame(animate);
            Matter.Engine.update(physicsWorld, 1000/60);
            filmReels.forEach(reel => {
                reel.three.position.x = (reel.position.x - window.innerWidth/2) * 0.02;
                reel.three.position.y = (reel.position.y - window.innerHeight/2) * 0.02;
                reel.three.rotation.z += reel.angle * 0.1;
                reel.three.rotation.x += 0.005;
                reel.three.rotation.y += 0.003;
            });
            camera.position.x = Math.sin(Date.now()*0.0001) * 5;
            camera.position.y = Math.cos(Date.now()*0.00015) * 3;
            camera.lookAt(scene.position);
            renderer.render(scene, camera);
            if (progress < 100) {
                progress += 0.2;
                document.getElementById('progress').style.width = progress + '%';
            }
            if (progress > 40 && getComputedStyle(document.getElementById('title-overlay')).opacity === '0') {
                document.getElementById('title-overlay').style.opacity = '1';
                document.querySelector('.loading').style.display = 'none';
            }
        }

        function init() {
            initThreeJS();
            initMatterJS();
            clock = new THREE.Clock();
            isAnimating = true;
            animate();
        }

        // ========== Full-page recording with user gesture ==========
        document.getElementById('record-button').addEventListener('click', async () => {
            const btn = document.getElementById('record-button');
            btn.textContent = 'Recording... (6s)';
            btn.classList.add('recording');
            btn.disabled = true;

            // Start animation if not already
            if (!isAnimating) init();

            try {
                // Ask for full tab capture (requires user gesture)
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        displaySurface: 'browser',
                        logicalSurface: true,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                });

                const recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });
                const chunks = [];

                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'cinema-title-full.webm';
                    a.click();
                    URL.revokeObjectURL(url);
                    stream.getTracks().forEach(t => t.stop());
                    btn.textContent = 'Recorded! Downloaded.';
                };

                recorder.start();
                // Record for 6 seconds
                setTimeout(() => {
                    recorder.stop();
                    btn.textContent = 'Done';
                }, 6000);

            } catch (err) {
                console.error('Recording failed:', err);
                btn.textContent = 'Failed – try again';
                btn.disabled = false;
                btn.classList.remove('recording');
            }
        });

        // Initialize on load (but don’t animate until recording starts or needed)
        window.addEventListener('load', () => {
            // Optional: preload assets, but defer animation
        });
    </script>
</body>
</html>
