# === LIBRARY COMPLETIONS ===

# ✅ FIXED: Define _get_catalog_entries (critical for mylib/runlib)
_get_catalog_entries() {
    local LIB_BASE="$HOME/AGRia-Video-Studio/CLI-Library"
    local CATALOG="$LIB_BASE/catalog.tsv"
    if [[ -f "$CATALOG" ]]; then
        # Skip header, get 2nd column (name), sort uniquely
        tail -n +2 "$CATALOG" | cut -f2 | sort -u
    fi
}

# ✅ FIXED: Removed duplicate _get_library_files (unused)
# (We don't need this — completions use _get_catalog_entries instead)

_mylib_completion() {
    local cur prev words cword
    if declare -F _init_completion >/dev/null 2>&1; then
        _init_completion || return
    else
        cur="${COMP_WORDS[COMP_CWORD]}"
        prev="${COMP_WORDS[COMP_CWORD-1]}"
        cword="$COMP_CWORD"
    fi

    local entries=($(_get_catalog_entries))  # ✅ Now defined!
    local flags="--show --edit"

    case "$cword" in
        1)
            if [[ "$cur" == --* ]]; then
                COMPREPLY=($(compgen -W "$flags" -- "$cur"))
            else
                COMPREPLY=($(compgen -W "${entries[*]}" -- "$cur"))
            fi
            ;;
        2)
            if [[ "$prev" == "--show" || "$prev" == "--edit" ]]; then
                COMPREPLY=($(compgen -W "${entries[*]}" -- "$cur"))
            else
                COMPREPLY=()
            fi
            ;;
        *)
            COMPREPLY=()
            ;;
    esac
}
complete -F _mylib_completion mylib

# addlib is interactive → no completion needed
_addlib_completion() { return 0; }
complete -F _addlib_completion addlib

# composite_two_step.sh completion (unchanged)
_composite_two_step_completion() {
    local cur prev words cword
    if declare -F _init_completion >/dev/null 2>&1; then
        _init_completion || return
    else
        cur="${COMP_WORDS[COMP_CWORD]}"
        prev="${COMP_WORDS[COMP_CWORD-1]}"
        cword="$COMP_CWORD"
    fi

    if (( cword == 1 )); then
        COMPREPLY=($(compgen -f -X '!*.@(mp4|mov|avi|webm|m4v)' -- "$cur"))
    elif (( cword == 2 )); then
        COMPREPLY=($(compgen -f -X '!*.@(mp4|mov|avi|webm|m4v|jpg|jpeg|png|gif)' -- "$cur"))
    else
        COMPREPLY=()
    fi
}
complete -F _composite_two_step_completion composite_two_step.sh
complete -F _composite_two_step_completion ./composite_two_step.sh
complete -F _composite_two_step_completion composite_two_step

# add_audio.sh completion (unchanged)
_add_audio_completion() {
    local cur="${COMP_WORDS[COMP_CWORD]}"
    case $COMP_CWORD in
        1) COMPREPLY=($(compgen -f -- "$cur" | grep -E '\.(mp4|mov|avi|webm|m4v)$' | sort -u)) ;;
        2) COMPREPLY=($(compgen -f -- "$cur" | grep -E '\.(m4a|mp3|wav|aac|flac|ogg)$' | sort -u)) ;;
        3) COMPREPLY=($(compgen -f -- "$cur" | grep -E '\.(mp4|mov)$' | sort -u)) ;;
        *) COMPREPLY=() ;;
    esac
}

# ✅ FIXED: runlib completion (uses _get_catalog_entries)
_runlib_completion() {
    local cur="${COMP_WORDS[COMP_CWORD]}"
    local cword="$COMP_CWORD"
    
    local LIB_BASE="$HOME/AGRia-Video-Studio/CLI-Library"
    local CATALOG="$LIB_BASE/catalog.tsv"
    local scripts=()
    if [[ -f "$CATALOG" ]]; then
        # Get ONLY type=script entries
        scripts=($(awk -F'\t' '$1 == "script" {print $2}' "$CATALOG" 2>/dev/null | sort -u))
    fi

    if (( cword == 1 )); then
        COMPREPLY=($(compgen -W "${scripts[*]}" -- "$cur"))
    else
        COMPREPLY=()
    fi
}
complete -F _runlib_completion runlib
