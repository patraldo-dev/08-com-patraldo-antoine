# === LIBRARY COMPLETIONS ===

# Helper: get all entry names from catalog.tsv (column 2)
_get_library_files() {
    local LIB_BASE="$HOME/AGRia-Video-Studio/CLI-Library"
    local files=()
    [[ -d "$LIB_BASE/scripts" ]] && files+=($(ls "$LIB_BASE/scripts" 2>/dev/null))
    [[ -d "$LIB_BASE/snippets" ]] && files+=($(ls "$LIB_BASE/snippets" 2>/dev/null))
    printf '%s\n' "${files[@]}" | sort -u
}

# Helper: get all filenames from scripts/ and snippets/
_get_library_files() {
    local LIB_BASE="$HOME/AGRia-Video-Studio/CLI-Library"
    local files=()
    [[ -d "$LIB_BASE/scripts" ]] && files+=($(ls "$LIB_BASE/scripts" 2>/dev/null))
    [[ -d "$LIB_BASE/snippets" ]] && files+=($(ls "$LIB_BASE/snippets" 2>/dev/null))
    printf '%s\n' "${files[@]}" | sort -u
}

_mylib_completion() {
    local cur prev words cword
    if declare -F _init_completion >/dev/null 2>&1; then
        _init_completion || return
    else
        # Fallback for systems without _init_completion (like older bash)
        cur="${COMP_WORDS[COMP_CWORD]}"
        prev="${COMP_WORDS[COMP_CWORD-1]}"
        cword="$COMP_CWORD"
    fi

    local entries=($(_get_catalog_entries))
    local flags="--show --edit"

    case "$cword" in
        1)
            # mylib <TAB> → complete flags or entry names
            if [[ "$cur" == --* ]]; then
                COMPREPLY=($(compgen -W "$flags" -- "$cur"))
            else
                COMPREPLY=($(compgen -W "${entries[*]}" -- "$cur"))
            fi
            ;;
        2)
            # mylib --show <TAB> or mylib --edit <TAB>
            if [[ "$prev" == "--show" || "$prev" == "--edit" ]]; then
                COMPREPLY=($(compgen -W "${entries[*]}" -- "$cur"))
            else
                # mylib somearg <TAB> → no completion (optional)
                COMPREPLY=()
            fi
            ;;
        *)
            COMPREPLY=()
            ;;
    esac
}
complete -F _mylib_completion mylib

# addlib is interactive → no filename completion needed
# But if you want to complete nothing (just avoid file completion):
_addlib_completion() {
    return 0
}
complete -F _addlib_completion addlib

# Completion for composite_two_step.sh (Wan video + background compositor)
_composite_two_step_completion() {
    local cur prev words cword
    if declare -F _init_completion >/dev/null 2>&1; then
        _init_completion || return
    else
        cur="${COMP_WORDS[COMP_CWORD]}"
        prev="${COMP_WORDS[COMP_CWORD-1]}"
        cword="$COMP_CWORD"
    fi

    # First arg: video (Wan output)
    if (( cword == 1 )); then
        COMPREPLY=($(compgen -f -X '!*.@(mp4|mov|avi|webm|m4v)' -- "$cur"))
    # Second arg: background (image or video)
    elif (( cword == 2 )); then
        COMPREPLY=($(compgen -f -X '!*.@(mp4|mov|avi|webm|m4v|jpg|jpeg|png|gif)' -- "$cur"))
    else
        COMPREPLY=()
    fi
}

# Register for common ways you might call it
complete -F _composite_two_step_completion composite_two_step.sh
complete -F _composite_two_step_completion ./composite_two_step.sh
complete -F _composite_two_step_completion composite_two_step

_add_audio_completion() {
    local cur="${COMP_WORDS[COMP_CWORD]}"
    case $COMP_CWORD in
        1)
            # Video files: mp4, mov, avi, webm, m4v
            COMPREPLY=($(compgen -f -- "$cur" | grep -E '\.(mp4|mov|avi|webm|m4v)$' | sort -u))
            ;;
        2)
            # Audio files: m4a, mp3, wav, aac, flac, ogg
            COMPREPLY=($(compgen -f -- "$cur" | grep -E '\.(m4a|mp3|wav|aac|flac|ogg)$' | sort -u))
            ;;
        3)
            # Output: mp4 or mov
            COMPREPLY=($(compgen -f -- "$cur" | grep -E '\.(mp4|mov)$' | sort -u))
            ;;
        *)
            COMPREPLY=()
            ;;
    esac
}

_runlib_completion() {
    local cur="${COMP_WORDS[COMP_CWORD]}"
    local cword="$COMP_CWORD"
    
    local LIB_BASE="$HOME/AGRia-Video-Studio/CLI-Library"
    local CATALOG="$LIB_BASE/catalog.tsv"
    local scripts=()
    if [[ -f "$CATALOG" ]]; then
        scripts=($(awk -F'\t' '$1 == "script" {print $2}' "$CATALOG" 2>/dev/null | sort -u))
    fi

    if (( cword == 1 )); then
        COMPREPLY=($(compgen -W "${scripts[*]}" -- "$cur"))
    else
        COMPREPLY=()
    fi
}
complete -F _runlib_completion runlib
