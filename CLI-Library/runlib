#!/bin/bash

# --- AUTO-RESOLVE LIB ROOT (follow symlinks) ---
REAL_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
LIB_ROOT="$(dirname "$REAL_PATH")"
SCRIPTS_DIR="$LIB_ROOT/scripts"
CATALOG="$LIB_ROOT/catalog.tsv"
# ------------------------------------------------

if [[ $# -lt 1 ]]; then
  echo "Usage: runlib <script_name> [args...]"
  echo "Example: runlib new_project.sh MyClient"
  exit 1
fi

SCRIPT_NAME="$1"
shift

# Validate: must be a .sh script (for safety)
if [[ "$SCRIPT_NAME" != *.sh ]]; then
  echo "‚ùå Only .sh scripts can be run via runlib"
  exit 1
fi

# Optional: verify it's in the catalog
if [[ -f "$CATALOG" ]]; then
  if ! grep -q $'\t'"$SCRIPT_NAME"$'\t' "$CATALOG"; then
    echo "‚ö†Ô∏è  Warning: '$SCRIPT_NAME' not in catalog. Add it with: addlib"
    # Continue anyway ‚Äî don't block
  fi
fi

# In runlib, after catalog check:
if [[ -f "$CATALOG" ]]; then
    requires_env=$(grep "^[^\t]*\t${SCRIPT_NAME}\t" "$CATALOG" | cut -f4)
    if [[ "$requires_env" == "yes" ]] && [[ ! -f "$LIB_ROOT/.env" ]]; then
        echo "‚ö†Ô∏è  WARNING: This script requires .env configuration"
        echo "   Create $LIB_ROOT/.env with required credentials"
        read -p "Continue anyway? (y/N): " cont
        [[ ! $cont =~ ^[Yy]$ ]] && exit 1
    fi
fi

# Check if script exists in scripts/
SCRIPT_PATH="$SCRIPTS_DIR/$SCRIPT_NAME"

# Check if script exists in scripts/
SCRIPT_PATH="$SCRIPTS_DIR/$SCRIPT_NAME"
if [[ ! -f "$SCRIPT_PATH" ]]; then
  echo "‚ùå Script not found: $SCRIPT_PATH"
  echo "   Ensure it's in: $SCRIPTS_DIR/"
  exit 1
fi

echo "üöÄ Running '$SCRIPT_NAME'..."
exec "$SCRIPT_PATH" "$@"
