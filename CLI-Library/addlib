#!/bin/bash

# --- SELF-CONTAINED PATH RESOLUTION ---
REAL_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
LIB_ROOT="$(dirname "$REAL_PATH")"
CATALOG="$LIB_ROOT/catalog.tsv"
SCRIPTS_DIR="$LIB_ROOT/scripts"
SNIPPETS_DIR="$LIB_ROOT/snippets"
# --------------------------------------

# Ensure catalog exists
mkdir -p "$LIB_ROOT" "$SCRIPTS_DIR" "$SNIPPETS_DIR"
if [[ ! -f "$CATALOG" ]]; then
  echo -e "type\tname\tdescription\tcontext" > "$CATALOG"
  echo "âœ… Created new catalog: $CATALOG"
fi

echo "âž• Add a new entry to your CLI library"
echo "-------------------------------------"

# 1. Type
PS3="Select type: "
select type in "script" "oneliner" "snippet" "function"; do
  if [[ -n "$type" ]]; then break; fi
  echo "âš ï¸  Invalid selection. Try again."
done

# 2. Name
read -rp "Enter name (e.g., strip_audio.sh): " name
while [[ -z "$name" ]]; do
  read -rp "Name is required: " name
done

# Enforce .sh extension for script/snippet
if [[ "$type" == "script" || "$type" == "snippet" ]] && [[ "$name" != *.sh ]]; then
  echo "ðŸ’¡ Auto-adding .sh extension for $type"
  name="$name.sh"
fi

# 3. Description
read -rp "Enter description: " desc
while [[ -z "$desc" ]]; do
  read -rp "Description is required: " desc
done

# 4. Context â€” with smarter defaults
echo
echo "ðŸ“Œ Common contexts:"
echo "   â€¢ portable       â†’ works anywhere (default)"
echo "   â€¢ AGRia-Video-Studio â†’ your main creative pipeline"
echo "   â€¢ web-i18n       â†’ SvelteKit multilingual sites"
echo "   â€¢ Wan-AI         â†’ AI animation workflows"
echo "   â€¢ Cloudflare     â†’ Workers/Images automation"

# Show existing contexts
EXISTING_CONTEXTS=$(tail -n +2 "$CATALOG" | cut -f4 | sort -u | grep -v '^$')
if [[ -n "$EXISTING_CONTEXTS" ]]; then
  echo
  echo "ðŸ“š Your existing contexts:"
  echo "$EXISTING_CONTEXTS" | sed 's/^/   â€¢ /'
fi

echo
read -rp "Enter context (press Enter for 'portable'): " context
context=${context:-portable}

# 5. Optional: Validate file exists (for script/snippet)
if [[ "$type" == "script" ]]; then
  if [[ ! -f "$SCRIPTS_DIR/$name" ]]; then
    echo "âš ï¸  Warning: Script not found in $SCRIPTS_DIR/"
    read -rp "Continue anyway? (y/N): " confirm
    [[ "$confirm" != [yY]* ]] && exit 1
  fi
elif [[ "$type" == "snippet" ]]; then
  if [[ ! -f "$SNIPPETS_DIR/$name" ]]; then
    echo "âš ï¸  Warning: Snippet not found in $SNIPPETS_DIR/"
    read -rp "Continue anyway? (y/N): " confirm
    [[ "$confirm" != [yY]* ]] && exit 1
  fi
fi

# Append to catalog
echo -e "$type\t$name\t$desc\t$context" >> "$CATALOG"

echo
echo "âœ… Added:"
printf "%-10s %-25s %s [%s]\n" "$type" "$name" "$desc" "$context"
echo
echo "ðŸ’¡ Tip: Edit $CATALOG anytime in Vim to refine entries."
