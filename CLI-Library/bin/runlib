#!/bin/bash

LIB_BASE="$HOME/AGRia-Video-Studio/CLI-Library"
CATALOG="$LIB_BASE/catalog.tsv"

if [[ $# -lt 1 ]]; then
  echo "Usage: runlib <script_name> [args...]"
  echo "Example: runlib new_project.sh MyClient"
  exit 1
fi

SCRIPT_NAME="$1"
shift  # remaining args go to the script

# Find context from catalog
CONTEXT=$(awk -F$'\t' -v name="$SCRIPT_NAME" '
  NR > 1 && $2 == name { print $4; exit }
' "$CATALOG")

if [[ -z "$CONTEXT" ]]; then
  echo "‚ùå '$SCRIPT_NAME' not found in catalog. Add it with: addlib"
  exit 1
fi

echo "üöÄ Running '$SCRIPT_NAME' (context: $CONTEXT)..."

case "$CONTEXT" in
  portable)
    if command -v "$SCRIPT_NAME" >/dev/null 2>&1; then
      "$SCRIPT_NAME" "$@"
    else
      echo "‚ö†Ô∏è  Portable script not in PATH: $SCRIPT_NAME"
      exit 1
    fi
    ;;

  AGRia-Video-Studio)
    TOOLS_DIR="$HOME/AGRia-Video-Studio/ToolsAndScripts"
    if [[ ! -f "$TOOLS_DIR/$SCRIPT_NAME" ]]; then
      echo "‚ùå Script not found: $TOOLS_DIR/$SCRIPT_NAME"
      exit 1
    fi
    (cd "$TOOLS_DIR" && ./"$SCRIPT_NAME" "$@")
    ;;

  GitHub)
    # Assume script is in CLI-Library/bin/ (portable-style)
    SCRIPT_PATH="$LIB_BASE/bin/$SCRIPT_NAME"
    if [[ -f "$SCRIPT_PATH" ]]; then
      "$SCRIPT_PATH" "$@"
    else
      echo "‚ùå GitHub script not found: $SCRIPT_PATH"
      exit 1
    fi
    ;;

  web-i18n)
    WEB_DIR="$HOME/path/to/your/sveltekit-project"  # üëà EDIT THIS!
    if [[ ! -f "$WEB_DIR/Tools/$SCRIPT_NAME" ]]; then
      echo "‚ùå Web script not found. Edit runlib to set WEB_DIR."
      exit 1
    fi
    (cd "$WEB_DIR/Tools" && ./"$SCRIPT_NAME" "$@")
    ;;

  *)
    # Fallback: assume it's in CLI-Library/bin
    SCRIPT_PATH="$LIB_BASE/bin/$SCRIPT_NAME"
    if [[ -f "$SCRIPT_PATH" ]]; then
      "$SCRIPT_PATH" "$@"
    else
      echo "‚ùå Unknown context '$CONTEXT' and no script at $SCRIPT_PATH"
      exit 1
    fi
    ;;
esac
