#!/bin/bash

LIBDIR="$HOME/AGRia-Video-Studio/CLI-Library"
CATALOG="$LIBDIR/catalog.tsv"

show_usage() {
  echo "Usage: mylib [<keyword>] | --show <name> | --edit <name>"
  echo "Examples:"
  echo "  mylib              # show full catalog"
  echo "  mylib ffmpeg       # search by keyword"
  echo "  mylib --show crop.sh"
  echo "  mylib --edit test_print.sh"
}

# Resolve full path based on type (script vs snippet)
resolve_script() {
  local name="$1"
  if [[ ! -f "$CATALOG" ]]; then
    echo "âŒ Catalog missing" >&2
    return 1
  fi

  # Look up type and name in catalog
  local entry=$(awk -F'\t' -v nm="$name" '$2 == nm {print $1 "\t" $2; exit}' "$CATALOG")
  if [[ -z "$entry" ]]; then
    echo "âŒ Not found in catalog: $name" >&2
    return 1
  fi

  local type=$(echo "$entry" | cut -f1)
  case "$type" in
    script)
      echo "$LIBDIR/bin/$name"
      ;;
    snippet)
      echo "$LIBDIR/snippets/$name"
      ;;
    *)
      echo "âŒ Unknown type: $type" >&2
      return 1
      ;;
  esac
}

# Main logic
if [[ $# -eq 0 ]]; then
  # Show full catalog (existing behavior)
  if [[ ! -f "$CATALOG" ]]; then
    echo "âŒ Catalog not found: $CATALOG"
    exit 1
  fi
  echo "ğŸ“š CLI Command Library"
  echo "Usage: mylib <keyword> | --show <name> | --edit <name>"
  echo
  column -t -s $'\t' "$CATALOG"
  exit 0
fi

# Handle --show and --edit
if [[ "$1" == "--show" || "$1" == "--edit" ]]; then
  if [[ $# -ne 2 ]]; then
    show_usage
    exit 1
  fi
  name="$2"
  path=$(resolve_script "$name")
  if [[ ! -f "$path" ]]; then
    echo "âŒ Script not found: $name (expected in $SCRIPTS_DIR)"
    exit 1
  fi

  if [[ "$1" == "--show" ]]; then
    echo "ğŸ“„ Showing: $path"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    cat "$path"
  elif [[ "$1" == "--edit" ]]; then
    echo "âœï¸ Editing: $path"
    vim "$path"
  fi
  exit 0
fi

# Default: keyword search (existing behavior)
if [[ ! -f "$CATALOG" ]]; then
  echo "âŒ Catalog not found: $CATALOG"
  exit 1
fi

RESULTS=$(grep -i "$*" "$CATALOG")
if [[ -z "$RESULTS" ]]; then
  echo "ğŸ” No matches for: $*"
  exit 1
fi

echo "$RESULTS" | column -t -s $'\t'
